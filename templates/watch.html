<!--
=============================================================================
VIDEO PLAYER PAGE TEMPLATE
=============================================================================
This page displays a single video with:
- Embedded video player (iframe for external videos)
- Video title and full description
- Category badge
- Social sharing buttons
- Back button to return to videos list
=============================================================================
-->
{% extends "base.html" %}

{% block title %}{{ video.title }} - homoflixcinema - Movie Streaming{% endblock %}

{% block content %}
<!-- 
=======================================================================
VIDEO PLAYER SECTION
=======================================================================
The main video player area with responsive iframe.
The iframe maintains a 16:9 aspect ratio.
-->
<section class="watch-section">
    <!-- Back navigation link -->
    <a href="{{ url_for('videos') }}" class="back-link">
        <i data-feather="arrow-left"></i>
        <span>Back to Videos</span>
    </a>
    
    <!-- Video player container - with loading handler -->
    <div class="video-player" id="videoPlayer">
        <div class="video-loading" id="videoLoading" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: absolute; background: var(--bg-secondary); border-radius: 12px;">
            <div style="text-align: center; color: var(--text-secondary);">
                <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                <p>Loading video...</p>
            </div>
        </div>
        <!-- Fit/Fill toggle -->
        <button id="fitToggle" class="fit-toggle" title="Toggle Fit/Fill">Fill</button>
        <video 
            id="videoElement"
            controls
            width="100%"
            style="display: none; width: 100%; height: 100%; border-radius: 12px; background: #000;">
        </video>
    </div>
    
    <div style="background: var(--bg-secondary); padding: var(--spacing-lg); border-radius: var(--radius-lg); margin-bottom: var(--spacing-lg);">
        <p style="color: var(--text-tertiary); font-size: 0.875rem; margin: 0;">
            <strong>Note:</strong> Video quality is based on the uploaded file. For best experience, ensure your video is uploaded in high quality to Google Drive.
        </p>
    </div>
    
    <!-- Video information section -->
    <div class="video-details">
        <h1 class="video-page-title">{{ video.title }}</h1>
        
        <!-- Meta information (duration, category) -->
        <div class="video-meta">
            <span class="meta-item">
                <i data-feather="clock"></i>
                {{ video.duration }}
            </span>
            <span class="meta-item category-tag">
                <i data-feather="tag"></i>
                {{ category_name }}
            </span>
            {% if video.tags %}
            <span class="meta-item category-tag">
                <i data-feather="tag"></i>
                {% for tag in video.tags %}
                    {{ get_category_name(tag) }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </span>
            {% endif %}
        </div>
        
        <!-- Social sharing buttons -->
        <div class="share-section">
            <h3 class="share-title">Share this video:</h3>
            <div class="share-buttons" id="shareButtons" data-url="{{ request.url }}" data-title="{{ video.title }}">
                <!-- Twitter/X Share -->
                <a href="#" 
                   class="share-btn share-twitter"
                   title="Share on Twitter"
                   onclick="shareOnTwitter(event)">
                    <i data-feather="twitter"></i>
                </a>
                
                <!-- Facebook Share -->
                <a href="#" 
                   class="share-btn share-facebook"
                   title="Share on Facebook"
                   onclick="shareOnFacebook(event)">
                    <i data-feather="facebook"></i>
                </a>
                
                <!-- LinkedIn Share -->
                <a href="#" 
                   class="share-btn share-linkedin"
                   title="Share on LinkedIn"
                   onclick="shareOnLinkedIn(event)">
                    <i data-feather="linkedin"></i>
                </a>
                
                <!-- Copy Link -->
                <button class="share-btn share-copy" 
                        onclick="copyVideoLink()"
                        title="Copy link">
                    <i data-feather="link"></i>
                </button>
            </div>
        </div>
        
        <!-- Full video description -->
        <div class="video-full-description">
            <h2>About This Video</h2>
            <p>{{ video.description }}</p>
        </div>
    </div>
</section>

<!-- HLS.js Library for .m3u8 streaming -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
// Handle video player loading with HLS.js
function applyAspectRatioFromMetadata(videoEl, containerEl) {
    if (!videoEl || !containerEl) return;
    const w = videoEl.videoWidth || 16;
    const h = videoEl.videoHeight || 9;
    if (w > 0 && h > 0) {
        const ratio = `${w} / ${h}`;
        console.log('Setting player aspect-ratio to', ratio);
        containerEl.style.aspectRatio = ratio;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('videoElement');
    const loading = document.getElementById('videoLoading');
    const videoSrc = '{{ video.video_url }}';
    const player = document.getElementById('videoPlayer');
    const fitToggle = document.getElementById('fitToggle');
    
    console.log('Loading video:', videoSrc);
    
    // Check if it's an HLS stream (.m3u8)
    if (videoSrc.includes('.m3u8')) {
        if (Hls.isSupported()) {
            console.log('HLS.js is supported, initializing...');
            const hls = new Hls({
                debug: true,
                enableWorker: true,
                lowLatencyMode: true,
            });
            
            hls.loadSource(videoSrc);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                console.log('HLS manifest loaded, video ready to play');
                loading.style.display = 'none';
                video.style.display = 'block';
                if (video.readyState >= 1) {
                    applyAspectRatioFromMetadata(video, player);
                } else {
                    video.addEventListener('loadedmetadata', function() {
                        applyAspectRatioFromMetadata(video, player);
                    }, { once: true });
                }
            });
            
            hls.on(Hls.Events.ERROR, function(event, data) {
                console.error('HLS Error:', data);
                if (data.fatal) {
                    switch(data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log('Network error, trying to recover...');
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.log('Media error, trying to recover...');
                            hls.recoverMediaError();
                            break;
                        default:
                            console.log('Fatal error, cannot recover');
                            loading.innerHTML = '<div style="text-align: center; color: var(--color-error);"><div style="font-size: 2rem; margin-bottom: 1rem;">❌</div><p>Video playback error. The stream may be protected or unavailable.</p></div>';
                            break;
                    }
                }
            });
        } 
        else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            // Native HLS support (Safari)
            console.log('Native HLS support detected');
            video.src = videoSrc;
            loading.style.display = 'none';
            video.style.display = 'block';
            video.addEventListener('loadedmetadata', function() {
                applyAspectRatioFromMetadata(video, player);
            }, { once: true });
        }
        else {
            console.error('HLS not supported on this browser');
            loading.innerHTML = '<div style="text-align: center; color: var(--color-error);"><div style="font-size: 2rem; margin-bottom: 1rem;">❌</div><p>Your browser does not support HLS streaming.</p></div>';
        }
    } else {
        // Regular video (MP4, etc.)
        console.log('Regular video source, using standard player');
        video.src = videoSrc;
        loading.style.display = 'none';
        video.style.display = 'block';
        video.addEventListener('loadedmetadata', function() {
            applyAspectRatioFromMetadata(video, player);
        }, { once: true });
    }

    // Toggle Fit/Fill behavior
    fitToggle.addEventListener('click', function() {
        const isFill = video.classList.toggle('fill-mode');
        fitToggle.textContent = isFill ? 'Fit' : 'Fill';
        fitToggle.title = isFill ? 'Show entire video' : 'Fill frame';
    });
});

function getShareData() {
    const container = document.getElementById('shareButtons');
    return {
        url: container.getAttribute('data-url'),
        title: container.getAttribute('data-title')
    };
}

function shareOnTwitter(event) {
    event.preventDefault();
    const data = getShareData();
    const twitterUrl = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(data.title) + '&url=' + encodeURIComponent(data.url);
    window.open(twitterUrl, '_blank', 'noopener,noreferrer');
}

function shareOnFacebook(event) {
    event.preventDefault();
    const data = getShareData();
    const fbUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(data.url);
    window.open(fbUrl, '_blank', 'noopener,noreferrer');
}

function shareOnLinkedIn(event) {
    event.preventDefault();
    const data = getShareData();
    const linkedInUrl = 'https://www.linkedin.com/shareArticle?mini=true&url=' + encodeURIComponent(data.url) + '&title=' + encodeURIComponent(data.title);
    window.open(linkedInUrl, '_blank', 'noopener,noreferrer');
}

function copyVideoLink() {
    const data = getShareData();
    navigator.clipboard.writeText(data.url).then(function() {
        alert('Link copied to clipboard!');
    }, function() {
        alert('Failed to copy link.');
    });
}
</script>
{% endblock %}
